/*
 Emily http://flams.github.com/emily

 The MIT License (MIT)

 Copyright (c) 2012 Olivier Scherrer <pode.fr@gmail.com>
*/
define("CouchDBStore",["Store","StateMachine","Tools","Promise"],function(b,f,h,e){function c(){var g=null,a={},d=new e,c={getView:function(){a.query=a.query||{};a.query.update_seq=true;g.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(c){var d=JSON.parse(c);if(d.rows)this.reset(d.rows),typeof d.total_rows=="undefined"&&this.setReducedViewInfo(true),b.event("subscribeToViewChanges",d.update_seq);else throw Error("CouchDBStore ["+a.database+
", "+a.design+", "+a.view+"].sync() failed: "+c);},this)},getDocument:function(){g.request("CouchDB",{method:"GET",path:"/"+a.database+"/"+a.document,query:a.query},function(a){a=JSON.parse(a);a._id?(this.reset(a),b.event("subscribeToDocumentChanges")):d.reject(this)},this)},getBulkDocuments:function(){var d={path:"/"+a.database+"/_all_docs",query:a.query},c;a.keys instanceof Array?(d.method="POST",d.data=JSON.stringify({keys:a.keys}),d.headers={"Content-Type":"application/json"},c=d.data):(d.method=
"GET",c=JSON.stringify(a.query));a.query.include_docs=true;a.query.update_seq=true;g.request("CouchDB",d,function(d){var e=JSON.parse(d);if(e.rows)this.reset(e.rows),b.event("subscribeToBulkChanges",e.update_seq);else throw Error('CouchDBStore.sync("'+a.database+'", '+c+") failed: "+d);},this)},createDocument:function(d){g.request("CouchDB",{method:"PUT",path:"/"+a.database+"/"+a.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(a){a=JSON.parse(a);a.ok?(d.resolve(a),
b.event("subscribeToDocumentChanges")):d.reject(a)})},subscribeToViewChanges:function(d){h.mixin({feed:"continuous",heartbeat:2E4,since:d},a.query);this.stopListening=g.listen("CouchDB",{path:"/"+a.database+"/_changes",query:a.query},function(d){if(d=="\n")return false;var d=JSON.parse(d),c;c=a.reducedView?"updateReduced":d.deleted?"delete":d.changes[0].rev.search("1-")==0?"add":"change";b.event(c,d.id)},this)},subscribeToDocumentChanges:function(){this.stopListening=g.listen("CouchDB",{path:"/"+
a.database+"/_changes",query:{feed:"continuous",heartbeat:2E4}},function(d){if(d=="\n")return false;d=JSON.parse(d);d.id==a.document&&d.changes.pop().rev!=this.get("_rev")&&(d.deleted?b.event("deleteDoc"):b.event("updateDoc"))},this)},subscribeToBulkChanges:function(d){h.mixin({feed:"continuous",heartbeat:2E4,since:d,include_docs:true},a.query);this.stopListening=g.listen("CouchDB",{path:"/"+a.database+"/_changes",query:a.query},function(a){if(a=="\n")return false;var a=JSON.parse(a),d;d=a.changes[0].rev.search("1-")==
0?"bulkAdd":a.deleted?"delete":"bulkChange";b.event(d,a.id,a.doc)},this)},updateDocInStore:function(d){g.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){JSON.parse(a).rows.some(function(a,c){a.id==d&&this.set(c,a)},this)},this)},addBulkDocInStore:function(d){if(a.query.startkey||a.query.endkey)a.query.include_docs=true,a.query.update_seq=true,g.request("CouchDB",{method:"GET",path:"/"+a.database+"/_all_docs",query:a.query},function(a){JSON.parse(a).rows.forEach(function(a,
c){a.id==d&&this.alter("splice",c,0,a.doc)},this)},this);else return false},updateBulkDocInStore:function(a,d){this.loop(function(c,b){c.id==a&&this.set(b,d)},this)},removeDocInStore:function(a){this.loop(function(d,c){d.id==a&&this.del(c)},this)},addDocInStore:function(d){g.request("CouchDB",{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){JSON.parse(a).rows.some(function(a,c){a.id==d&&this.alter("splice",c,0,a)},this)},this)},updateReduced:function(){g.request("CouchDB",
{method:"GET",path:"/"+a.database+"/_design/"+a.design+"/"+a.view,query:a.query},function(a){this.set(0,JSON.parse(a).rows[0])},this)},updateDoc:function(){g.request("CouchDB",{method:"GET",path:"/"+a.database+"/"+a.document},function(a){this.reset(JSON.parse(a))},this)},deleteDoc:function(){this.reset({})},updateDatabase:function(d){g.request("CouchDB",{method:"PUT",path:"/"+a.database+"/"+a.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(a){a=JSON.parse(a);a.ok?
d.resolve(a):d.reject(a)})},updateDatabaseWithBulkDoc:function(d){var c=[];this.loop(function(a){c.push(a.doc)});g.request("CouchDB",{method:"POST",path:"/"+a.database+"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:c})},function(a){d.resolve(JSON.parse(a))})},removeFromDatabase:function(){g.request("CouchDB",{method:"DELETE",path:"/"+a.database+"/"+a.document,query:{rev:this.get("_rev")}})},resolve:function(){d.resolve(this)},unsync:function(){this.stopListening();
delete this.stopListening}},b=new f("Unsynched",{Unsynched:[["getView",c.getView,this,"Synched"],["getDocument",c.getDocument,this,"Synched"],["getBulkDocuments",c.getBulkDocuments,this,"Synched"]],Synched:[["updateDatabase",c.createDocument,this],["subscribeToViewChanges",c.subscribeToViewChanges,this,"Listening"],["subscribeToDocumentChanges",c.subscribeToDocumentChanges,this,"Listening"],["subscribeToBulkChanges",c.subscribeToBulkChanges,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["entry",
c.resolve,this],["change",c.updateDocInStore,this],["bulkAdd",c.addBulkDocInStore,this],["bulkChange",c.updateBulkDocInStore,this],["delete",c.removeDocInStore,this],["add",c.addDocInStore,this],["updateReduced",c.updateReduced,this],["updateDoc",c.updateDoc,this],["deleteDoc",c.deleteDoc,this],["updateDatabase",c.updateDatabase,this],["updateDatabaseWithBulkDoc",c.updateDatabaseWithBulkDoc,this],["removeFromDatabase",c.removeFromDatabase,this],["unsync",c.unsync,this,"Unsynched"]]});this.sync=function(a,
c,e,g){if(typeof a=="string"&&typeof c=="string"&&typeof e=="string")return this.setSyncInfo(a,c,e,g),b.event("getView"),d;else if(typeof a=="string"&&typeof c=="string"&&typeof e!="string")return this.setSyncInfo(a,c,e),b.event("getDocument"),d;else if(typeof a=="string"&&c instanceof Object)return this.setSyncInfo(a,c),b.event("getBulkDocuments"),d;return false};this.setSyncInfo=function(d,c,e,b){this.clearSyncInfo();if(typeof d=="string"&&typeof c=="string"&&typeof e=="string")return a.database=
d,a.design=c,a.view=e,a.query=b,true;else if(typeof d=="string"&&typeof c=="string"&&typeof e!="string")return a.database=d,a.document=c,a.query=e,true;else if(typeof d=="string"&&c instanceof Object){a.database=d;a.query=c;if(a.query.keys instanceof Array)a.keys=a.query.keys,delete a.query.keys;return true}return false};this.clearSyncInfo=function(){a={};return true};this.setReducedViewInfo=function(d){return typeof d=="boolean"?(a.reducedView=d,true):false};this.getSyncInfo=function(){return a};
this.unsync=function(){return b.event("unsync")};this.upload=function(){var d=new e;if(a.document)return b.event("updateDatabase",d),d;else if(!a.view)return b.event("updateDatabaseWithBulkDoc",d),d;return false};this.remove=function(){return a.document?b.event("removeFromDatabase"):false};this.setTransport=function(a){return a&&typeof a.listen=="function"&&typeof a.request=="function"?(g=a,true):false};this.getStateMachine=function(){return b};this.getTransport=function(){return g};this.actions=
c}return function(){c.prototype=new b;return new c}});
define("Observable",["Tools"],function(b){return function(){var f={};this.watch=function(b,e,c){if(typeof e=="function"){var g=f[b]=f[b]||[];observer=[e,c];g.push(observer);return[b,g.indexOf(observer)]}else return false};this.unwatch=function(b){var e=b[0],b=b[1];return f[e]&&f[e][b]?(delete f[e][b],f[e].some(function(c){return!!c})||delete f[e],true):false};this.notify=function(h){var e=f[h],c;if(e){for(c=e.length;c--;)e[c]&&e[c][0].apply(e[c][1]||null,b.toArray(arguments).slice(1));return true}else return false};
this.hasObserver=function(b){return!(!b||!f[b[0]]||!f[b[0]][b[1]])};this.hasTopic=function(b){return!!f[b]};this.unwatchAll=function(b){f[b]?delete f[b]:f={};return true}}});
define("Promise",["Observable","StateMachine"],function(b,f){return function(){var h,e,c=new f("Unresolved",{Unresolved:[["resolve",function(a){h=a;g.notify("success",a)},"Resolved"],["reject",function(a){e=a;g.notify("fail",a)},"Rejected"],["addSuccess",function(a,d){g.watch("success",a,d)}],["addFail",function(a,d){g.watch("fail",a,d)}]],Resolved:[["addSuccess",function(a,d){a.call(d,h)}]],Rejected:[["addFail",function(a,d){a.call(d,e)}]]}),g=new b;this.resolve=function(a){return c.event("resolve",
a)};this.reject=function(a){return c.event("reject",a)};this.then=function(a,d,b,e){a instanceof Function&&(d instanceof Function?c.event("addSuccess",a):c.event("addSuccess",a,d));d instanceof Function&&c.event("addFail",d,b);b instanceof Function&&c.event("addFail",b,e);return this};this.getObservable=function(){return g};this.getStateMachine=function(){return c}}});
define("StateMachine",["Tools"],function(b){function f(){var f={};this.add=function(b,c,g,a){var d=[];if(f[b])return false;return typeof b=="string"&&typeof c=="function"?(d[0]=c,typeof g=="object"&&(d[1]=g),typeof g=="string"&&(d[2]=g),typeof a=="string"&&(d[2]=a),f[b]=d,true):false};this.has=function(b){return!!f[b]};this.get=function(b){return f[b]||false};this.event=function c(c){var g=f[c];return g?(g[0].apply(g[1],b.toArray(arguments).slice(1)),g[2]):false}}return function(h,e){var c={},g="";
this.init=function(a){return c[a]?(g=a,true):false};this.add=function(a){return c[a]?false:c[a]=new f};this.get=function(a){return c[a]};this.getCurrent=function(){return g};this.event=function(a){var d;d=c[g].event.apply(c[g].event,b.toArray(arguments));return d===false?false:(d&&(c[g].event("exit"),g=d,c[g].event("entry")),true)};b.loop(e,function(a,d){var c=this.add(d);a.forEach(function(a){c.add.apply(null,a)})},this);this.init(h)}});
define("Store",["Observable","Tools"],function(b,f){return function(h){var e=f.clone(h)||{},c=new b,g=new b,a=function(a){var b=f.objectsDiffs(a,e);["updated","deleted","added"].forEach(function(a){b[a].forEach(function(d){c.notify(a,d,e[d]);g.notify(d,e[d],a)})})};this.getNbItems=function(){return e instanceof Array?e.length:f.count(e)};this.get=function(a){return e[a]};this.has=function(a){return e.hasOwnProperty(a)};this.set=function(a,b){var f;return typeof a!="undefined"?(f=this.has(a),e[a]=
b,f=f?"updated":"added",c.notify(f,a,e[a]),g.notify(a,e[a],f),true):false};this.update=function(a,b,e){var h;return this.has(a)?(h=this.get(a),f.setNestedProperty(h,b,e),c.notify("updated",b,e),g.notify(a,h,"updated"),true):false};this.del=function(a){return this.has(a)?(this.alter("splice",a,1)||(delete e[a],c.notify("deleted",a),g.notify(a,e[a],"deleted")),true):false};this.delAll=function(a){return a instanceof Array?(a.sort(f.compareNumbers).reverse().forEach(this.del,this),true):false};this.alter=
function(d){var c,b;return e[d]?(b=f.clone(e),c=e[d].apply(e,Array.prototype.slice.call(arguments,1)),a(b),c):false};this.watch=function(a,b,e){return c.watch(a,b,e)};this.unwatch=function(a){return c.unwatch(a)};this.getStoreObservable=function(){return c};this.watchValue=function(a,b,c){return g.watch(a,b,c)};this.unwatchValue=function(a){return g.unwatch(a)};this.getValueObservable=function(){return g};this.loop=function(a,b){f.loop(e,a,b)};this.reset=function(b){if(b instanceof Object){var c=
f.clone(e);e=f.clone(b)||{};a(c);return true}else return false};this.toJSON=function(){return JSON.stringify(e)}}});
define("Tools",function(){return{getGlobal:function(){return function(){return this}.call(null)},mixin:function(b,f,h){this.loop(b,function(e,c){if(!f[c]||!h)f[c]=b[c]});return f},count:function(b){var f=0;this.loop(b,function(){f++});return f},compareObjects:function(b,f){return Object.getOwnPropertyNames(b).sort().join("")==Object.getOwnPropertyNames(f).sort().join("")},compareNumbers:function(b,f){return b>f?1:b<f?-1:0},toArray:function(b){return Array.prototype.slice.call(b)},loop:function(b,
f,h){var e,c;if(b instanceof Object&&typeof f=="function"){if(c=b.length)for(e=0;e<c;e++)f.call(h,b[e],e,b);else for(e in b)b.hasOwnProperty(e)&&f.call(h,b[e],e,b);return true}else return false},objectsDiffs:function(b,f){if(b instanceof Object&&f instanceof Object){var h=[],e=[],c=[],g=[];this.loop(f,function(a,c){typeof b[c]=="undefined"?g.push(c):a!==b[c]?e.push(c):a===b[c]&&h.push(c)});this.loop(b,function(a,b){typeof f[b]=="undefined"&&c.push(b)});return{updated:e,unchanged:h,added:g,deleted:c}}else return false},
jsonify:function(b){return b instanceof Object?JSON.parse(JSON.stringify(b)):false},clone:function(b){return b instanceof Array?b.slice(0):typeof b=="object"&&b!==null&&!(b instanceof RegExp)?this.mixin(b,{}):false},getNestedProperty:function(b,f){return b&&b instanceof Object?typeof f=="string"&&f!=""?f.split(".").reduce(function(b,e){return b&&b[e]},b):typeof f=="number"?b[f]:b:b},setNestedProperty:function(b,f,h){if(b&&b instanceof Object)if(typeof f=="string"&&f!=""){var e=f.split(".");return e.reduce(function(b,
f,a){b[f]=b[f]||{};e.length==a+1&&(b[f]=h);return b[f]},b)}else return typeof f=="number"?(b[f]=h,b[f]):b;else return b}}});
define("Transport",["Store","Tools"],function(b,f){return function(h){var e=null;this.setReqHandlers=function(c){return c instanceof b?(e=c,true):false};this.getReqHandlers=function(){return e};this.request=function(b,f,a,d){return e.has(b)&&typeof f=="object"?(e.get(b)(f,function(){a&&a.apply(d,arguments)}),true):false};this.listen=function(b,g,a,d){if(e.has(b)&&typeof g=="object"&&typeof g.path=="string"&&typeof a=="function"){var h=function(){a.apply(d,arguments)},i;f.mixin({__keepalive__:true,
method:"get"},g);i=e.get(b)(g,h,h);return function(){i.func.call(i.scope)}}else return false};this.setReqHandlers(h)}});
