define("CouchDBStore",["Store","StateMachine","Tools"],function(a,c){function g(){var b=null,d=null,a=null,f=null,h=new c("Unsynched",{Unsynched:[["getView",function(){b.request("CouchDB",{method:"GET",path:"/"+d+"/_design/"+f+"/_view/"+a+"?update_seq=true"},function(b){b=JSON.parse(b);g={total_rows:b.total_rows,update_seq:b.update_seq,offset:b.offset};this.reset(b.rows);h.event("subscribeToChanges",b.update_seq)},this)},this,"Synched"]],Synched:[["subscribeToChanges",function(f){b.listen("CouchDB",
{method:"GET",path:"/"+d+"/_changes?feed=continuous&heartbeat=20000&since="+f},function(b){b=JSON.parse(b);h.event(b.deleted?"delete":b.changes[0].rev[0]=="1"?"add":"change",b.id)},this)},this,"Listening"]],Listening:[["change",function(c){b.request("CouchDB",{method:"GET",path:"/"+d+"/_design/"+f+"/_view/"+a},function(b){JSON.parse(b).rows.some(function(b,f){b.id==c&&this.set(f,b)},this)},this)},this],["delete",function(b){this.loop(function(f,c){f.id==b&&this.del(c)},this)},this],["add",function(c){b.request("CouchDB",
{method:"GET",path:"/"+d+"/_design/"+f+"/_view/"+a},function(b){JSON.parse(b).rows.some(function(b,f){b.id==c&&this.alter("splice",f,0,b)},this)},this)},this]]}),g={};this.sync=function(b,c,g){return typeof b=="string"&&typeof c=="string"&&typeof g=="string"?(d=b,f=c,a=g,h.event("getView"),true):false};this.getDBInfo=function(b){return g[b]};this.setTransport=function(f){return f&&typeof f.listen=="function"&&typeof f.request?(b=f,true):false};this.getState=function(){return h.getCurrent()};this.getTransport=
function(){return b}}return function(){g.prototype=new a;return new g}});
define("Observable",["Tools"],function(a){return function(){var c={};this.watch=function(a,b,d){if(typeof b=="function"){var e=c[a]=c[a]||[];observer=[b,d];e.push(observer);return[a,e.indexOf(observer)]}else return false};this.unwatch=function(a){var b=a[0],a=a[1];return c[b]&&c[b][a]?(c[b][a]=null,true):false};this.notify=function(g){var b=c[g],d;if(b){for(d=b.length;d--;)b[d]&&b[d][0].apply(b[d][1]||null,a.toArray(arguments).slice(1));return true}else return false};this.hasObserver=function(a){return!(!a||
!c[a[0]]||!c[a[0]][a[1]])};this.unwatchAll=function(a){c[a]?delete c[a]:c={};return true}}});
define("Promise",["StateMachine","Observable","Tools"],function(a,c,g){return function(b,d){var e=null,f=null,h=null,j=null,i=new a("Unresolved",{Unresolved:[["resolve",function(){e.call(f,function(){return i.event.apply(i,g.toArray(arguments))})}],["success",function(b){h=b;k.notify("success",b)},"Resolved"],["fail",function(b){j=b;k.notify("fail",b)},"Failed"],["addThen",function(b,a,f){k.watch(b,a,f)}]],Resolved:[["addThen",function(b,a,f){a.call(f,b=="success"?h:j)}]],Failed:[["addThen",function(b,
a,f){a.call(f,b=="success"?h:j)}]]}),k=new c;this.then=function(b,a,f,c){b instanceof Function&&(a instanceof Function?i.event("addThen","success",a):i.event("addThen","success",b,a));a instanceof Function&&i.event("addThen","fail",a,f);f instanceof Function&&i.event("addThen","fail",f,c)};this.resolve=function(){return!(!e||!i.event("resolve"))};this.getState=function(){return i.getCurrent()};b instanceof Function&&(e=b,f=d)}});
define("StateMachine",["Tools"],function(a){function c(){var c={};this.add=function(b,a,e,f){var h=[];if(c[b])return false;return typeof b=="string"&&typeof a=="function"?(h[0]=a,typeof e=="object"&&(h[1]=e),typeof e=="string"&&(h[2]=e),typeof f=="string"&&(h[2]=f),c[b]=h,true):false};this.has=function(b){return!!c[b]};this.event=function d(d){var e=c[d];return e?(e[0].apply(e[1],a.toArray(arguments).slice(1)),e[2]):false}}return function(g,b){var d={},e="";this.init=function(b){return d[b]?(e=b,
true):false};this.add=function(b){return d[b]?false:d[b]=new c};this.get=function(b){return d[b]};this.getCurrent=function(){return e};this.event=function(b){var c=d[e].event.apply(d[e].event,a.toArray(arguments));return c===false?false:(e=c||e,true)};a.loop(b,function(b,a){var c=this.add(a);b.forEach(function(b){c.add.apply(null,b)})},this);this.init(g)}});define("StaticProxy",function(){return function(a){this.trap=function(c,g){var b=a[c];a[c]=function(){g();b()}}}});
define("Store",["Observable","Tools"],function(a,c){return function(g){var b=c.clone(g)||{},d=new a,e=function(a){var h=c.objectsDiffs(a,b);["updated","deleted","added"].forEach(function(a){h[a].forEach(function(c){d.notify(a,c,b[c])})})};this.getNbItems=function(){return b instanceof Array?b.length:c.count(b)};this.get=function(a){return b[a]};this.has=function(a){return b.hasOwnProperty(a)};this.set=function(a,c){var e;return typeof a!="undefined"?(e=this.has(a),b[a]=c,e?d.notify("updated",a,b[a]):
d.notify("added",a,b[a]),true):false};this.del=function(a){return this.has(a)?(this.alter("splice",a,1)||(delete b[a],d.notify("deleted",a)),true):false};this.alter=function(a){var d,g;return b[a]?(g=c.clone(b),d=b[a].apply(b,Array.prototype.slice.call(arguments,1)),e(g),d):false};this.watch=function(b,a,c){return d.watch(b,a,c)};this.unwatch=function(b){return d.unwatch(b)};this.loop=function(a,d){c.loop(b,a,d)};this.reset=function(a){if(a instanceof Object){var d=c.clone(b);b=c.clone(a)||{};e(d);
return true}else return false}}});
define("Tools",function(){return{getGlobal:function(){return function(){return this}.call(null)},mixin:function(a,c,g){this.loop(a,function(b,d){if(!c[d]||!g)c[d]=a[d]});return c},count:function(a){var c=0;this.loop(a,function(){c++});return c},compareObjects:function(a,c){return Object.getOwnPropertyNames(a).sort().join("")==Object.getOwnPropertyNames(c).sort().join("")},toArray:function(a){return Array.prototype.slice.call(a)},loop:function(a,c,g){var b;if(a instanceof Object&&typeof c=="function"){if(a instanceof
Array)a.forEach(c,g);else for(b in a)a.hasOwnProperty(b)&&c.call(g,a[b],b,a);return true}else return false},objectsDiffs:function(a,c){if(a instanceof Object&&c instanceof Object){var g=[],b=[],d=[],e=[];this.loop(c,function(c,d){c!==a[d]&&typeof a[d]!="undefined"?b.push(d):c===a[d]?g.push(d):typeof a[d]=="undefined"&&e.push(d)});this.loop(a,function(b,a){typeof c[a]=="undefined"&&d.push(a)});return{updated:b,unchanged:g,added:e,deleted:d}}else return false},jsonify:function(a){return a instanceof
Object?JSON.parse(JSON.stringify(a)):false},clone:function(a){return a instanceof Array?a.slice(0):typeof a=="object"&&a!==null&&!(a instanceof RegExp)?this.mixin(a,{}):a}}});
define("Transport",function(){return function(a){var c,g=io;this.connect=function(b){c=g.connect(b);return!!c};this.getSocket=function(){return c};this.on=function(b,a){c.on(b,a)};this.once=function(b,a){c.once(b,a)};this.emit=function(b,a,e){c.emit(b,a,e)};this.request=function(b,a,e,f){var g=Date.now()+Math.floor(Math.random()*1E6),j=function(){e.apply(f||null,arguments)};c[a.keptAlive?"on":"once"](g,j);a.__eventId__=g;c.emit(b,a);if(a.keptAlive)return{stop:function(){c.removeListener(g,j)}}};this.listen=
function(a,c,e,f){c.keptAlive=true;return this.request(a,c,e,f)};this.connect(a)}});
