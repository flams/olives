define("CouchDBStore",["Store","StateMachine","Tools"],function(e,d){function c(){var a=null,f=null,c=null,b=null,e=null,i={},h=new d("Unsynched",{Unsynched:[["getView",function(){a.request("CouchDB",{method:"GET",path:"/"+f+"/_design/"+e+"/_view/"+c+"?update_seq=true"},function(b){b=JSON.parse(b);i={total_rows:b.total_rows,update_seq:b.update_seq,offset:b.offset};this.reset(b.rows);h.event("subscribeToViewChanges",b.update_seq)},this)},this,"Synched"],["getDocument",function(){a.request("CouchDB",
{method:"GET",path:"/"+f+"/"+b},function(b){this.reset(JSON.parse(b));h.event("subscribeToDocumentChanges")},this)},this,"Synched"]],Synched:[["subscribeToViewChanges",function(b){a.listen("CouchDB","/"+f+"/_changes?feed=continuous&heartbeat=20000&since="+b,function(b){if(b=="\n")return false;var b=JSON.parse(b),a;a=b.deleted?"delete":b.changes[0].rev.search("1-")==0?"add":"change";h.event(a,b.id)},this)},this,"Listening"],["subscribeToDocumentChanges",function(){a.listen("CouchDB","/"+f+"/_changes?feed=continuous&heartbeat=20000",
function(a){if(a=="\n")return false;a=JSON.parse(a);a.id==b&&(a.deleted?h.event("deleteDoc"):h.event("updateDoc"))},this)},this,"Listening"]],Listening:[["change",function(b){a.request("CouchDB",{method:"GET",path:"/"+f+"/_design/"+e+"/_view/"+c},function(a){JSON.parse(a).rows.some(function(a,c){a.id==b&&this.set(c,a)},this)},this)},this],["delete",function(b){this.loop(function(a,c){a.id==b&&this.del(c)},this)},this],["add",function(b){a.request("CouchDB",{method:"GET",path:"/"+f+"/_design/"+e+"/_view/"+
c},function(a){JSON.parse(a).rows.some(function(a,c){a.id==b&&this.alter("splice",c,0,a)},this)},this)},this],["updateDoc",function(){a.request("CouchDB",{method:"GET",path:"/"+f+"/"+b},function(b){this.reset(JSON.parse(b))},this)},this],["deleteDoc",function(){this.reset({})},this]]});this.sync=function(a,d,i){if(typeof a=="string"&&typeof d=="string"&&typeof i=="string")return f=a,e=d,c=i,h.event("getView"),true;else if(typeof a=="string"&&typeof d=="string"&&typeof i=="undefined")return f=a,b=
d,h.event("getDocument"),true;return false};this.getDBInfo=function(b){return i[b]};this.setTransport=function(b){return b&&typeof b.listen=="function"&&typeof b.request=="function"?(a=b,true):false};this.getState=function(){return h.getCurrent()};this.getTransport=function(){return a}}return function(){c.prototype=new e;return new c}});
define("Observable",["Tools"],function(e){return function(){var d={};this.watch=function(c,a,f){if(typeof a=="function"){var e=d[c]=d[c]||[];observer=[a,f];e.push(observer);return[c,e.indexOf(observer)]}else return false};this.unwatch=function(c){var a=c[0],c=c[1];return d[a]&&d[a][c]?(delete d[a][c],d[a].some(function(a){return!!a})||delete d[a],true):false};this.notify=function(c){var a=d[c],f;if(a){for(f=a.length;f--;)a[f]&&a[f][0].apply(a[f][1]||null,e.toArray(arguments).slice(1));return true}else return false};
this.hasObserver=function(c){return!(!c||!d[c[0]]||!d[c[0]][c[1]])};this.hasTopic=function(c){return!!d[c]};this.unwatchAll=function(c){d[c]?delete d[c]:d={};return true}}});
define("Promise",["StateMachine","Observable","Tools"],function(e,d,c){return function(a,f){var g=null,b=null,j=null,i=null,h=new d;_stateMachine=new e("Unresolved",{Unresolved:[["resolve",function(){g.call(b,function(){return _stateMachine.event.apply(_stateMachine,c.toArray(arguments))})}],["success",function(b){j=b;h.notify("success",b)},"Resolved"],["fail",function(b){i=b;h.notify("fail",b)},"Failed"],["addThen",function(b,a,c){h.watch(b,a,c)}]],Resolved:[["addThen",function(b,a,c){a.call(c,b==
"success"?j:i)}]],Failed:[["addThen",function(b,a,c){a.call(c,b=="success"?j:i)}]]});this.then=function(b,a,c,e){b instanceof Function&&(a instanceof Function?_stateMachine.event("addThen","success",a):_stateMachine.event("addThen","success",b,a));a instanceof Function&&_stateMachine.event("addThen","fail",a,c);c instanceof Function&&_stateMachine.event("addThen","fail",c,e)};this.resolve=function(){return!(!g||!_stateMachine.event("resolve"))};this.getState=function(){return _stateMachine.getCurrent()};
a instanceof Function&&(g=a,b=f)}});
define("StateMachine",["Tools"],function(e){function d(){var c={};this.add=function(a,e,d,b){var j=[];if(c[a])return false;return typeof a=="string"&&typeof e=="function"?(j[0]=e,typeof d=="object"&&(j[1]=d),typeof d=="string"&&(j[2]=d),typeof b=="string"&&(j[2]=b),c[a]=j,true):false};this.has=function(a){return!!c[a]};this.event=function f(f){var d=c[f];return d?(d[0].apply(d[1],e.toArray(arguments).slice(1)),d[2]):false}}return function(c,a){var f={},g="";this.init=function(b){return f[b]?(g=b,
true):false};this.add=function(b){return f[b]?false:f[b]=new d};this.get=function(b){return f[b]};this.getCurrent=function(){return g};this.event=function(b){var a=f[g].event.apply(f[g].event,e.toArray(arguments));return a===false?false:(g=a||g,true)};e.loop(a,function(b,a){var c=this.add(a);b.forEach(function(b){c.add.apply(null,b)})},this);this.init(c)}});
define("Store",["Observable","Tools"],function(e,d){return function(c){var a=d.clone(c)||{},f=new e,g=function(b){var c=d.objectsDiffs(b,a);["updated","deleted","added"].forEach(function(b){c[b].forEach(function(c){f.notify(b,c,a[c])})})};this.getNbItems=function(){return a instanceof Array?a.length:d.count(a)};this.get=function(b){return a[b]};this.has=function(b){return a.hasOwnProperty(b)};this.set=function(b,c){var d;return typeof b!="undefined"?(d=this.has(b),a[b]=c,d?f.notify("updated",b,a[b]):
f.notify("added",b,a[b]),true):false};this.del=function(b){return this.has(b)?(this.alter("splice",b,1)||(delete a[b],f.notify("deleted",b)),true):false};this.alter=function(b){var c,e;return a[b]?(e=d.clone(a),c=a[b].apply(a,Array.prototype.slice.call(arguments,1)),g(e),c):false};this.watch=function(b,a,c){return f.watch(b,a,c)};this.unwatch=function(b){return f.unwatch(b)};this.loop=function(b,c){d.loop(a,b,c)};this.reset=function(b){if(b instanceof Object){var c=d.clone(a);a=d.clone(b)||{};g(c);
return true}else return false}}});
define("Tools",function(){return{getGlobal:function(){return function(){return this}.call(null)},mixin:function(e,d,c){this.loop(e,function(a,f){if(!d[f]||!c)d[f]=e[f]});return d},count:function(e){var d=0;this.loop(e,function(){d++});return d},compareObjects:function(e,d){return Object.getOwnPropertyNames(e).sort().join("")==Object.getOwnPropertyNames(d).sort().join("")},toArray:function(e){return Array.prototype.slice.call(e)},loop:function(e,d,c){var a;if(e instanceof Object&&typeof d=="function"){if(e instanceof
Array)e.forEach(d,c);else for(a in e)e.hasOwnProperty(a)&&d.call(c,e[a],a,e);return true}else return false},objectsDiffs:function(e,d){if(e instanceof Object&&d instanceof Object){var c=[],a=[],f=[],g=[];this.loop(d,function(b,d){b!==e[d]&&typeof e[d]!="undefined"?a.push(d):b===e[d]?c.push(d):typeof e[d]=="undefined"&&g.push(d)});this.loop(e,function(b,a){typeof d[a]=="undefined"&&f.push(a)});return{updated:a,unchanged:c,added:g,deleted:f}}else return false},jsonify:function(e){return e instanceof
Object?JSON.parse(JSON.stringify(e)):false},clone:function(e){return e instanceof Array?e.slice(0):typeof e=="object"&&e!==null&&!(e instanceof RegExp)?this.mixin(e,{}):e},getObjectsProperty:function(e,d){if(e instanceof Object&&typeof d=="string"){var c=d.split(".");c.unshift(e);return c.reduce(function(a,c){return a[c]})}else return false}}});
define("Transport",["Observable"],function(e){return function(d){var c,a=io,f=new e;this.connect=function(d){c=a.connect(d);return!!c};this.getSocket=function(){return c};this.on=function(a,b){c.on(a,b)};this.once=function(a,b){c.once(a,b)};this.emit=function(a,b,d){c.emit(a,b,d)};this.request=function(a,b,d,e){var f=Date.now()+Math.floor(Math.random()*1E6),k=function(){d.apply(e||null,arguments)};c[b.keptAlive?"on":"once"](f,k);b.__eventId__=f;c.emit(a,b);if(b.keptAlive)return function(){c.removeListener(f,
k)}};this.listen=function(a,b,c,d){var e=a+"/"+b,k,l;f.hasTopic(e)||(l=this.request(a,{path:b,method:"GET",keptAlive:true},function(a){f.notify(e,a)},this));k=f.watch(e,c,d);return{stop:function(){f.unwatch(k);f.hasTopic(e)||l()}}};this.getListenObservable=function(){return f};this.connect(d)}});
