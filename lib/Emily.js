define("CouchDBStore",["Store","StateMachine","Tools"],function(a,c){function f(){var b=null,d=null,a=null,g=null,h=new c("Unsynched",{Unsynched:[["getView",function(){b.request("CouchDB",{method:"GET",path:"/"+d+"/_design/"+g+"/_view/"+a+"?update_seq=true"},function(b){b=JSON.parse(b);f={total_rows:b.total_rows,update_seq:b.update_seq,offset:b.offset};this.reset(b.rows);h.event("subscribeToChanges",b.update_seq)},this)},this,"Synched"]],Synched:[["subscribeToChanges",function(g){var a=b.listen("CouchDB",
{method:"GET",path:"/"+d+"/_changes?feed=continuous&heartbeat=20000&since="+g},function(b){JSON.parse(b).deleted?h.event("delete",JSON.parse(b).id,a):h.event("change",JSON.parse(b).id,a)},this)},this,"Listening"]],Listening:[["change",function(c){b.request("CouchDB",{method:"GET",path:"/"+d+"/_design/"+g+"/_view/"+a+'?key="'+c+'"'},function(b){b=JSON.parse(b);this.set(b.offset,b.rows[0])},this)},this],["delete",function(b){this.loop(function(g,a){g.id==b&&this.del(a)},this)},this]]}),f={};this.sync=
function(b,c,f){return typeof b=="string"&&typeof c=="string"&&typeof f=="string"?(d=b,g=c,a=f,h.event("getView"),true):false};this.getDBInfo=function(b){return f[b]};this.setTransport=function(g){return g&&typeof g.listen=="function"&&typeof g.request?(b=g,true):false};this.getState=function(){return h.getCurrent()};this.getTransport=function(){return b}}f.prototype=new a;return f});
define("Observable",["Tools"],function(a){return function(){var c={};this.watch=function(a,b,d){if(typeof b=="function"){var e=c[a]=c[a]||[];observer=[b,d];e.push(observer);return[a,e.indexOf(observer)]}else return false};this.unwatch=function(a){var b=a[0],a=a[1];return c[b]&&c[b][a]?(c[b][a]=null,true):false};this.notify=function(f){var b=c[f],d;if(b){for(d=b.length;d--;)b[d]&&b[d][0].apply(b[d][1]||null,a.toArray(arguments).slice(1));return true}else return false};this.hasObserver=function(a){return!(!a||
!c[a[0]]||!c[a[0]][a[1]])};this.unwatchAll=function(a){c[a]?delete c[a]:c={};return true}}});
define("Promise",["StateMachine","Observable","Tools"],function(a,c,f){return function(b,d){var e=null,g=null,h=null,j=null,i=new a("Unresolved",{Unresolved:[["resolve",function(){e.call(g,function(){return i.event.apply(i,f.toArray(arguments))})}],["success",function(b){h=b;k.notify("success",b)},"Resolved"],["fail",function(b){j=b;k.notify("fail",b)},"Failed"],["addThen",function(b,a,g){k.watch(b,a,g)}]],Resolved:[["addThen",function(b,a,g){a.call(g,b=="success"?h:j)}]],Failed:[["addThen",function(b,
a,g){a.call(g,b=="success"?h:j)}]]}),k=new c;this.then=function(b,a,g,c){b instanceof Function&&(a instanceof Function?i.event("addThen","success",a):i.event("addThen","success",b,a));a instanceof Function&&i.event("addThen","fail",a,g);g instanceof Function&&i.event("addThen","fail",g,c)};this.resolve=function(){return!(!e||!i.event("resolve"))};this.getState=function(){return i.getCurrent()};b instanceof Function&&(e=b,g=d)}});
define("StateMachine",["Tools"],function(a){function c(){var c={};this.add=function(b,a,e,g){var h=[];if(c[b])return false;return typeof b=="string"&&typeof a=="function"?(h[0]=a,typeof e=="object"&&(h[1]=e),typeof e=="string"&&(h[2]=e),typeof g=="string"&&(h[2]=g),c[b]=h,true):false};this.has=function(b){return!!c[b]};this.event=function d(d){var e=c[d];return e?(e[0].apply(e[1],a.toArray(arguments).slice(1)),e[2]):false}}return function(f,b){var d={},e="";this.init=function(b){return d[b]?(e=b,
true):false};this.add=function(b){return d[b]?false:d[b]=new c};this.get=function(b){return d[b]};this.getCurrent=function(){return e};this.event=function(b){var c=d[e].event.apply(d[e].event,a.toArray(arguments));return c===false?false:(e=c||e,true)};a.loop(b,function(b,a){var c=this.add(a);b.forEach(function(b){c.add.apply(null,b)})},this);this.init(f)}});define("StaticProxy",function(){return function(a){this.trap=function(c,f){var b=a[c];a[c]=function(){f();b()}}}});
define("Store",["Observable","Tools"],function(a,c){return function(f){var b=c.clone(f)||{},d=new a,e=function(a){var h=c.objectsDiffs(a,b);["updated","deleted","added"].forEach(function(a){h[a].forEach(function(c){d.notify(a,c,b[c])})})};this.getNbItems=function(){return b instanceof Array?b.length:c.count(b)};this.get=function(a){return b[a]};this.has=function(a){return b.hasOwnProperty(a)};this.set=function(a,c){var e;return typeof a!="undefined"?(e=this.has(a),b[a]=c,e?d.notify("updated",a,b[a]):
d.notify("added",a,b[a]),true):false};this.del=function(a){return this.has(a)?(this.alter("splice",a,1)||(delete b[a],d.notify("deleted",a)),true):false};this.alter=function(a){var d,f;return b[a]?(f=c.clone(b),d=b[a].apply(b,Array.prototype.slice.call(arguments,1)),e(f),d):false};this.watch=function(b,a,c){return d.watch(b,a,c)};this.unwatch=function(b){return d.unwatch(b)};this.loop=function(a,d){c.loop(b,a,d)};this.reset=function(a){if(a instanceof Object){var d=c.clone(b);b=c.clone(a)||{};e(d);
return true}else return false}}});
define("Tools",function(){return{getGlobal:function(){return function(){return this}.call(null)},mixin:function(a,c,f){this.loop(a,function(b,d){if(!c[d]||!f)c[d]=a[d]});return c},count:function(a){var c=0;this.loop(a,function(){c++});return c},compareObjects:function(a,c){return Object.getOwnPropertyNames(a).sort().join("")==Object.getOwnPropertyNames(c).sort().join("")},toArray:function(a){return Array.prototype.slice.call(a)},loop:function(a,c,f){var b;if(a instanceof Object&&typeof c=="function"){if(a instanceof
Array)a.forEach(c,f);else for(b in a)a.hasOwnProperty(b)&&c.call(f,a[b],b,a);return true}else return false},objectsDiffs:function(a,c){if(a instanceof Object&&c instanceof Object){var f=[],b=[],d=[],e=[];this.loop(c,function(c,d){c!==a[d]&&typeof a[d]!="undefined"?b.push(d):c===a[d]?f.push(d):typeof a[d]=="undefined"&&e.push(d)});this.loop(a,function(a,b){typeof c[b]=="undefined"&&d.push(b)});return{updated:b,unchanged:f,added:e,deleted:d}}else return false},jsonify:function(a){return a instanceof
Object?JSON.parse(JSON.stringify(a)):false},clone:function(a){return a instanceof Array?a.slice(0):typeof a=="object"&&a!==null&&!(a instanceof RegExp)?this.mixin(a,{}):a}}});
define("Transport",function(){return function(a){var c,f=io;this.connect=function(b){c=f.connect(b);return!!c};this.getSocket=function(){return c};this.on=function(b,a){c.on(b,a)};this.once=function(a,d){c.once(a,d)};this.emit=function(a,d,e){c.emit(a,d,e)};this.request=function(a,d,e,g){var f=Date.now()+Math.floor(Math.random()*1E6),j=function(){e.apply(g||null,arguments)};c[d.keptAlive?"on":"once"](f,j);d.__eventId__=f;c.emit(a,d);if(d.keptAlive)return{stop:function(){c.removeListener(f,j)}}};this.listen=
function(a,c,e,f){c.keptAlive=true;return this.request(a,c,e,f)};this.connect(a)}});
