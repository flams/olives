/*
 Emily

 The MIT License (MIT)

 Copyright (c) 2012 Olivier Scherrer <pode.fr@gmail.com>
*/
define("CouchDBStore",["Store","StateMachine","Tools","Promise"],function(a,d,h,e){function c(){var c=null,b={},f=new e,a={getView:function(){b.query=b.query||{};b.query.update_seq=true;c.request("CouchDB",{method:"GET",path:"/"+b.database+"/_design/"+b.design+"/_view/"+b.view,query:b.query},function(f){var a=JSON.parse(f);if(a.rows)this.reset(a.rows),i.event("subscribeToViewChanges",a.update_seq);else throw Error("CouchDBStore ["+b.database+", "+b.design+", "+b.view+"].sync() failed: "+f);},this)},
getDocument:function(){c.request("CouchDB",{method:"GET",path:"/"+b.database+"/"+b.document,query:b.query},function(b){b=JSON.parse(b);b._id?(this.reset(b),i.event("subscribeToDocumentChanges")):f.reject(this)},this)},createDocument:function(){c.request("CouchDB",{method:"PUT",path:"/"+b.database+"/"+b.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(){i.event("subscribeToDocumentChanges")})},subscribeToViewChanges:function(f){h.mixin({feed:"continuous",heartbeat:2E4,
since:f},b.query);this.stopListening=c.listen("CouchDB",{path:"/"+b.database+"/_changes",query:b.query},function(b){if(b=="\n")return false;var b=JSON.parse(b),f;f=b.deleted?"delete":b.changes[0].rev.search("1-")==0?"add":"change";i.event(f,b.id)},this)},subscribeToDocumentChanges:function(){this.stopListening=c.listen("CouchDB",{path:"/"+b.database+"/_changes",query:{feed:"continuous",heartbeat:2E4}},function(f){if(f=="\n")return false;f=JSON.parse(f);f.id==b.document&&f.changes.pop().rev!=this.get("_rev")&&
(f.deleted?i.event("deleteDoc"):i.event("updateDoc"))},this)},updateDocInStore:function(f){c.request("CouchDB",{method:"GET",path:"/"+b.database+"/_design/"+b.design+"/_view/"+b.view,query:b.query},function(b){JSON.parse(b).rows.some(function(b,a){b.id==f&&this.set(a,b)},this)},this)},removeDocInStore:function(b){this.loop(function(f,a){f.id==b&&this.del(a)},this)},addDocInStore:function(f){c.request("CouchDB",{method:"GET",path:"/"+b.database+"/_design/"+b.design+"/_view/"+b.view,query:b.query},
function(b){JSON.parse(b).rows.some(function(b,a){b.id==f&&this.alter("splice",a,0,b)},this)},this)},updateDoc:function(){c.request("CouchDB",{method:"GET",path:"/"+b.database+"/"+b.document},function(b){this.reset(JSON.parse(b))},this)},deleteDoc:function(){this.reset({})},updateDatabase:function(){c.request("CouchDB",{method:"PUT",path:"/"+b.database+"/"+b.document,headers:{"Content-Type":"application/json"},data:this.toJSON()})},removeFromDatabase:function(){c.request("CouchDB",{method:"DELETE",
path:"/"+b.database+"/"+b.document,query:{rev:this.get("_rev")}})},resolve:function(){f.resolve(this)},unsync:function(){this.stopListening();delete this.stopListening}},i=new d("Unsynched",{Unsynched:[["getView",a.getView,this,"Synched"],["getDocument",a.getDocument,this,"Synched"]],Synched:[["updateDatabase",a.createDocument,this],["subscribeToViewChanges",a.subscribeToViewChanges,this,"Listening"],["subscribeToDocumentChanges",a.subscribeToDocumentChanges,this,"Listening"],["unsync",function(){},
"Unsynched"]],Listening:[["entry",a.resolve,this],["change",a.updateDocInStore,this],["delete",a.removeDocInStore,this],["add",a.addDocInStore,this],["updateDoc",a.updateDoc,this],["deleteDoc",a.deleteDoc,this],["updateDatabase",a.updateDatabase,this],["removeFromDatabase",a.removeFromDatabase,this],["unsync",a.unsync,this,"Unsynched"]]});this.sync=function(b,a,c,e){if(typeof b=="string"&&typeof a=="string"&&typeof c=="string")return this.setSyncInfo(b,a,c,e),i.event("getView"),f;else if(typeof b==
"string"&&typeof a=="string"&&typeof c!="string")return this.setSyncInfo(b,a,c),i.event("getDocument"),f;return false};this.setSyncInfo=function(f,a,c,e){if(typeof f=="string"&&typeof a=="string"&&typeof c=="string")return b.database=f,b.design=a,b.view=c,b.query=e,true;else if(typeof f=="string"&&typeof a=="string"&&typeof c!="string")return b.database=f,b.document=a,b.query=c,true;return false};this.getSyncInfo=function(){return b};this.unsync=function(){return i.event("unsync")};this.upload=function(){return i.event("updateDatabase")};
this.remove=function(){return i.event("removeFromDatabase")};this.setTransport=function(b){return b&&typeof b.listen=="function"&&typeof b.request=="function"?(c=b,true):false};this.getStateMachine=function(){return i};this.getTransport=function(){return c};this.actions=a}return function(){c.prototype=new a;return new c}});
define("Observable",["Tools"],function(a){return function(){var d={};this.watch=function(a,e,c){if(typeof e=="function"){var g=d[a]=d[a]||[];observer=[e,c];g.push(observer);return[a,g.indexOf(observer)]}else return false};this.unwatch=function(a){var e=a[0],a=a[1];return d[e]&&d[e][a]?(delete d[e][a],d[e].some(function(a){return!!a})||delete d[e],true):false};this.notify=function(h){var e=d[h],c;if(e){for(c=e.length;c--;)e[c]&&e[c][0].apply(e[c][1]||null,a.toArray(arguments).slice(1));return true}else return false};
this.hasObserver=function(a){return!(!a||!d[a[0]]||!d[a[0]][a[1]])};this.hasTopic=function(a){return!!d[a]};this.unwatchAll=function(a){d[a]?delete d[a]:d={};return true}}});
define("Promise",["Observable","StateMachine"],function(a,d){return function(){var h,e,c=new d("Unresolved",{Unresolved:[["resolve",function(b){h=b;g.notify("success",b)},"Resolved"],["reject",function(b){e=b;g.notify("fail",b)},"Rejected"],["addSuccess",function(b,a){g.watch("success",b,a)}],["addFail",function(b,a){g.watch("fail",b,a)}]],Resolved:[["addSuccess",function(a,f){a.call(f,h)}]],Rejected:[["addFail",function(a,f){a.call(f,e)}]]}),g=new a;this.resolve=function(a){return c.event("resolve",
a)};this.reject=function(a){return c.event("reject",a)};this.then=function(a,f,e,d){a instanceof Function&&(f instanceof Function?c.event("addSuccess",a):c.event("addSuccess",a,f));f instanceof Function&&c.event("addFail",f,e);e instanceof Function&&c.event("addFail",e,d);return this};this.getObservable=function(){return g};this.getStateMachine=function(){return c}}});
define("StateMachine",["Tools"],function(a){function d(){var d={};this.add=function(a,c,g,b){var f=[];if(d[a])return false;return typeof a=="string"&&typeof c=="function"?(f[0]=c,typeof g=="object"&&(f[1]=g),typeof g=="string"&&(f[2]=g),typeof b=="string"&&(f[2]=b),d[a]=f,true):false};this.has=function(a){return!!d[a]};this.get=function(a){return d[a]||false};this.event=function c(c){var g=d[c];return g?(g[0].apply(g[1],a.toArray(arguments).slice(1)),g[2]):false}}return function(h,e){var c={},g="";
this.init=function(a){return c[a]?(g=a,true):false};this.add=function(a){return c[a]?false:c[a]=new d};this.get=function(a){return c[a]};this.getCurrent=function(){return g};this.event=function(b){var f;f=c[g].event.apply(c[g].event,a.toArray(arguments));return f===false?false:(f&&(c[g].event("exit"),g=f,c[g].event("entry")),true)};a.loop(e,function(a,f){var c=this.add(f);a.forEach(function(a){c.add.apply(null,a)})},this);this.init(h)}});
define("Store",["Observable","Tools"],function(a,d){return function(h){var e=d.clone(h)||{},c=new a,g=new a,b=function(a){var b=d.objectsDiffs(a,e);["updated","deleted","added"].forEach(function(a){b[a].forEach(function(b){c.notify(a,b,e[b]);g.notify(b,e[b],a)})})};this.getNbItems=function(){return e instanceof Array?e.length:d.count(e)};this.get=function(a){return e[a]};this.has=function(a){return e.hasOwnProperty(a)};this.set=function(a,b){var d;return typeof a!="undefined"?(d=this.has(a),e[a]=
b,d=d?"updated":"added",c.notify(d,a,e[a]),g.notify(a,e[a],d),true):false};this.update=function(a,b,e){var h;return this.has(a)?(h=this.get(a),d.setNestedProperty(h,b,e),c.notify("updated",b,e),g.notify(a,h,"updated"),true):false};this.del=function(a){return this.has(a)?(this.alter("splice",a,1)||(delete e[a],c.notify("deleted",a),g.notify(a,e[a],"deleted")),true):false};this.delAll=function(a){return a instanceof Array?(a.sort(d.compareNumbers).reverse().forEach(this.del,this),true):false};this.alter=
function(a){var c,g;return e[a]?(g=d.clone(e),c=e[a].apply(e,Array.prototype.slice.call(arguments,1)),b(g),c):false};this.watch=function(a,b,e){return c.watch(a,b,e)};this.unwatch=function(a){return c.unwatch(a)};this.getStoreObservable=function(){return c};this.watchValue=function(a,b,c){return g.watch(a,b,c)};this.unwatchValue=function(a){return g.unwatch(a)};this.getValueObservable=function(){return g};this.loop=function(a,b){d.loop(e,a,b)};this.reset=function(a){if(a instanceof Object){var c=
d.clone(e);e=d.clone(a)||{};b(c);return true}else return false};this.toJSON=function(){return JSON.stringify(e)}}});
define("Tools",function(){return{getGlobal:function(){return function(){return this}.call(null)},mixin:function(a,d,h){this.loop(a,function(e,c){if(!d[c]||!h)d[c]=a[c]});return d},count:function(a){var d=0;this.loop(a,function(){d++});return d},compareObjects:function(a,d){return Object.getOwnPropertyNames(a).sort().join("")==Object.getOwnPropertyNames(d).sort().join("")},compareNumbers:function(a,d){return a>d?1:a<d?-1:0},toArray:function(a){return Array.prototype.slice.call(a)},loop:function(a,
d,h){var e,c;if(a instanceof Object&&typeof d=="function"){if(c=a.length)for(e=0;e<c;e++)d.call(h,a[e],e,a);else for(e in a)a.hasOwnProperty(e)&&d.call(h,a[e],e,a);return true}else return false},objectsDiffs:function(a,d){if(a instanceof Object&&d instanceof Object){var h=[],e=[],c=[],g=[];this.loop(d,function(b,c){typeof a[c]=="undefined"?g.push(c):b!==a[c]?e.push(c):b===a[c]&&h.push(c)});this.loop(a,function(a,e){typeof d[e]=="undefined"&&c.push(e)});return{updated:e,unchanged:h,added:g,deleted:c}}else return false},
jsonify:function(a){return a instanceof Object?JSON.parse(JSON.stringify(a)):false},clone:function(a){return a instanceof Array?a.slice(0):typeof a=="object"&&a!==null&&!(a instanceof RegExp)?this.mixin(a,{}):false},getNestedProperty:function(a,d){return a&&a instanceof Object?typeof d=="string"&&d!=""?d.split(".").reduce(function(a,e){return a&&a[e]},a):typeof d=="number"?a[d]:a:a},setNestedProperty:function(a,d,h){if(a&&a instanceof Object)if(typeof d=="string"&&d!=""){var e=d.split(".");return e.reduce(function(a,
d,b){a[d]=a[d]||{};e.length==b+1&&(a[d]=h);return a[d]},a)}else return typeof d=="number"?(a[d]=h,a[d]):a;else return a}}});
define("Transport",["Store","Tools"],function(a,d){return function(h){var e=null;this.setReqHandlers=function(c){return c instanceof a?(e=c,true):false};this.getReqHandlers=function(){return e};this.request=function(a,d,b,f){return e.has(a)&&typeof d=="object"?(e.get(a)(d,function(){b.apply(f,arguments)}),true):false};this.listen=function(a,g,b,f){if(e.has(a)&&typeof g=="object"&&typeof g.path=="string"&&typeof b=="function"){var h=function(){b.apply(f,arguments)},i;d.mixin({keptAlive:true,method:"get"},
g);i=e.get(a)(g,h,h);return function(){i.func.call(i.scope)}}else return false};this.setReqHandlers(h)}});
