define("CouchDBStore",["Store","StateMachine","Tools","Promise"],function(a,e,f,d){function c(){var c=null,h=null,b=null,a=null,f=null,j={},k=new d,i=new e("Unsynched",{Unsynched:[["getView",function(){c.request("CouchDB",{method:"GET",path:"/"+h+"/_design/"+f+"/_view/"+b+"?update_seq=true"},function(b){b=JSON.parse(b);j={total_rows:b.total_rows,update_seq:b.update_seq,offset:b.offset};this.reset(b.rows);i.event("subscribeToViewChanges",b.update_seq)},this)},this,"Synched"],["getDocument",function(){c.request("CouchDB",
{method:"GET",path:"/"+h+"/"+a},function(b){b=JSON.parse(b);b._id?(this.reset(b),i.event("subscribeToDocumentChanges")):k.reject(this)},this)},this,"Synched"]],Synched:[["updateDatabase",function(){c.request("CouchDB",{method:"PUT",path:"/"+h+"/"+a,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(){i.event("subscribeToDocumentChanges")})},this],["subscribeToViewChanges",function(b){c.listen("CouchDB","/"+h+"/_changes?feed=continuous&heartbeat=20000&since="+b,function(b){if(b==
"\n")return false;var b=JSON.parse(b),c;c=b.deleted?"delete":b.changes[0].rev.search("1-")==0?"add":"change";i.event(c,b.id)},this)},this,"Listening"],["subscribeToDocumentChanges",function(){c.listen("CouchDB","/"+h+"/_changes?feed=continuous&heartbeat=20000",function(b){if(b=="\n")return false;b=JSON.parse(b);b.id==a&&b.changes.pop().rev!=this.get("_rev")&&(b.deleted?i.event("deleteDoc"):i.event("updateDoc"))},this)},this,"Listening"]],Listening:[["entry",function(){k.resolve(this)},this],["change",
function(d){c.request("CouchDB",{method:"GET",path:"/"+h+"/_design/"+f+"/_view/"+b},function(b){JSON.parse(b).rows.some(function(b,c){b.id==d&&this.set(c,b)},this)},this)},this],["delete",function(b){this.loop(function(c,d){c.id==b&&this.del(d)},this)},this],["add",function(d){c.request("CouchDB",{method:"GET",path:"/"+h+"/_design/"+f+"/_view/"+b},function(b){JSON.parse(b).rows.some(function(b,c){b.id==d&&this.alter("splice",c,0,b)},this)},this)},this],["updateDoc",function(){c.request("CouchDB",
{method:"GET",path:"/"+h+"/"+a},function(b){this.reset(JSON.parse(b))},this)},this],["deleteDoc",function(){this.reset({})},this],["updateDatabase",function(){c.request("CouchDB",{method:"PUT",path:"/"+h+"/"+a,headers:{"Content-Type":"application/json"},data:this.toJSON()})},this],["removeFromDatabase",function(){c.request("CouchDB",{method:"DELETE",path:"/"+h+"/"+a+"?rev="+this.get("_rev")})},this]]});this.sync=function(c,d,e){if(typeof c=="string"&&typeof d=="string"&&typeof e=="string")return h=
c,f=d,b=e,i.event("getView"),k;else if(typeof c=="string"&&typeof d=="string"&&typeof e=="undefined")return h=c,a=d,i.event("getDocument"),k;return false};this.update=function(){return i.event("updateDatabase")};this.remove=function(){return i.event("removeFromDatabase")};this.getDBInfo=function(b){return j[b]};this.setTransport=function(b){return b&&typeof b.listen=="function"&&typeof b.request=="function"?(c=b,true):false};this.getStateMachine=function(){return i};this.getTransport=function(){return c}}
return function(){c.prototype=new a;return new c}});
define("Observable",["Tools"],function(a){return function(){var e={};this.watch=function(a,d,c){if(typeof d=="function"){var g=e[a]=e[a]||[];observer=[d,c];g.push(observer);return[a,g.indexOf(observer)]}else return false};this.unwatch=function(a){var d=a[0],a=a[1];return e[d]&&e[d][a]?(delete e[d][a],e[d].some(function(c){return!!c})||delete e[d],true):false};this.notify=function(f){var d=e[f],c;if(d){for(c=d.length;c--;)d[c]&&d[c][0].apply(d[c][1]||null,a.toArray(arguments).slice(1));return true}else return false};
this.hasObserver=function(a){return!(!a||!e[a[0]]||!e[a[0]][a[1]])};this.hasTopic=function(a){return!!e[a]};this.unwatchAll=function(a){e[a]?delete e[a]:e={};return true}}});
define("Promise",["Observable","StateMachine"],function(a,e){return function(){var f,d,c=new e("Unresolved",{Unresolved:[["resolve",function(c){f=c;g.notify("success",c)},"Resolved"],["reject",function(c){d=c;g.notify("fail",c)},"Rejected"],["addSuccess",function(c,b){g.watch("success",c,b)}],["addFail",function(c,b){g.watch("fail",c,b)}]],Resolved:[["addSuccess",function(c,b){c.call(b,f)}]],Rejected:[["addFail",function(c,b){c.call(b,d)}]]}),g=new a;this.resolve=function(a){return c.event("resolve",
a)};this.reject=function(a){return c.event("reject",a)};this.then=function(a,b,d,e){a instanceof Function&&(b instanceof Function?c.event("addSuccess",a):c.event("addSuccess",a,b));b instanceof Function&&c.event("addFail",b,d);d instanceof Function&&c.event("addFail",d,e);return this};this.getObservable=function(){return g};this.getStateMachine=function(){return c}}});
define("StateMachine",["Tools"],function(a){function e(){var e={};this.add=function(a,c,g,h){var b=[];if(e[a])return false;return typeof a=="string"&&typeof c=="function"?(b[0]=c,typeof g=="object"&&(b[1]=g),typeof g=="string"&&(b[2]=g),typeof h=="string"&&(b[2]=h),e[a]=b,true):false};this.has=function(a){return!!e[a]};this.event=function c(c){var g=e[c];return g?(g[0].apply(g[1],a.toArray(arguments).slice(1)),g[2]):false}}return function(f,d){var c={},g="";this.init=function(a){return c[a]?(g=a,
true):false};this.add=function(a){return c[a]?false:c[a]=new e};this.get=function(a){return c[a]};this.getCurrent=function(){return g};this.event=function(d){var b;b=c[g].event.apply(c[g].event,a.toArray(arguments));return b===false?false:(b&&(c[g].event("exit"),g=b,c[g].event("entry")),true)};a.loop(d,function(a,b){var c=this.add(b);a.forEach(function(b){c.add.apply(null,b)})},this);this.init(f)}});
define("Store",["Observable","Tools"],function(a,e){return function(f){var d=e.clone(f)||{},c=new a,g=new a,h=function(b){var a=e.objectsDiffs(b,d);["updated","deleted","added"].forEach(function(b){a[b].forEach(function(a){c.notify(b,a,d[a]);g.notify(a,d[a])})})};this.getNbItems=function(){return d instanceof Array?d.length:e.count(d)};this.get=function(b){return d[b]};this.has=function(b){return d.hasOwnProperty(b)};this.set=function(b,a){var e;return typeof b!="undefined"?(e=this.has(b),d[b]=a,
e?c.notify("updated",b,d[b]):c.notify("added",b,d[b]),g.notify(b,d[b]),true):false};this.del=function(b){return this.has(b)?(this.alter("splice",b,1)||(delete d[b],c.notify("deleted",b),g.notify(b)),true):false};this.alter=function(b){var a,c;return d[b]?(c=e.clone(d),a=d[b].apply(d,Array.prototype.slice.call(arguments,1)),h(c),a):false};this.watch=function(b,a,d){return c.watch(b,a,d)};this.unwatch=function(b){return c.unwatch(b)};this.getStoreObservable=function(){return c};this.watchValue=function(b,
a,c){return g.watch(b,a,c)};this.unwatchValue=function(b){return g.unwatch(b)};this.getValueObservable=function(){return g};this.loop=function(b,a){e.loop(d,b,a)};this.reset=function(b){if(b instanceof Object){var a=e.clone(d);d=e.clone(b)||{};h(a);return true}else return false};this.toJSON=function(){return JSON.stringify(d)}}});
define("Tools",function(){return{getGlobal:function(){return function(){return this}.call(null)},mixin:function(a,e,f){this.loop(a,function(d,c){if(!e[c]||!f)e[c]=a[c]});return e},count:function(a){var e=0;this.loop(a,function(){e++});return e},compareObjects:function(a,e){return Object.getOwnPropertyNames(a).sort().join("")==Object.getOwnPropertyNames(e).sort().join("")},toArray:function(a){return Array.prototype.slice.call(a)},loop:function(a,e,f){var d,c;if(a instanceof Object&&typeof e=="function"){if(c=
a.length)for(d=0;d<c;d++)e.call(f,a[d],d,a);else for(d in a)a.hasOwnProperty(d)&&e.call(f,a[d],d,a);return true}else return false},objectsDiffs:function(a,e){if(a instanceof Object&&e instanceof Object){var f=[],d=[],c=[],g=[];this.loop(e,function(c,b){c!==a[b]&&typeof a[b]!="undefined"?d.push(b):c===a[b]?f.push(b):typeof a[b]=="undefined"&&g.push(b)});this.loop(a,function(a,b){typeof e[b]=="undefined"&&c.push(b)});return{updated:d,unchanged:f,added:g,deleted:c}}else return false},jsonify:function(a){return a instanceof
Object?JSON.parse(JSON.stringify(a)):false},clone:function(a){return a instanceof Array?a.slice(0):typeof a=="object"&&a!==null&&!(a instanceof RegExp)?this.mixin(a,{}):a},getNestedProperty:function(a,e){if(a&&a instanceof Object&&typeof e=="string"&&e!=""){var f=e.split(".");f.unshift(a);return f.reduce(function(a,c){return a[c]})}else return a}}});
define("Transport",["Observable"],function(a){return function(e){var f=null,d=io,c=new a;this.connect=function(a){f=d.connect(a);return!!f};this.getSocket=function(){return f};this.on=function(a,c){f.on(a,c)};this.once=function(a,c){f.once(a,c)};this.emit=function(a,c,b){f.emit(a,c,b)};this.request=function(a,c,b,d){var e=Date.now()+Math.floor(Math.random()*1E6),j=function(){b&&b.apply(d||null,arguments)};f[c.keptAlive?"on":"once"](e,j);c.__eventId__=e;f.emit(a,c);if(c.keptAlive)return function(){f.removeListener(e,
j)}};this.listen=function(a,d,b,e){var f=a+"/"+d,j,k;c.hasTopic(f)||(k=this.request(a,{path:d,method:"GET",keptAlive:true},function(a){c.notify(f,a)},this));j=c.watch(f,b,e);return{stop:function(){c.unwatch(j);c.hasTopic(f)||k()}}};this.getListenObservable=function(){return c};this.connect(e)}});
