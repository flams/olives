define("CouchDBStore",["Store","StateMachine","Tools","Promise"],function(a,d,f,e){function c(){var a=null,h=null,b=null,c=null,f=null,j={},k=new e,i=new d("Unsynched",{Unsynched:[["getView",function(){a.request("CouchDB",{method:"GET",path:"/"+h+"/_design/"+f+"/_view/"+b+"?update_seq=true"},function(b){b=JSON.parse(b);j={total_rows:b.total_rows,update_seq:b.update_seq,offset:b.offset};this.reset(b.rows);i.event("subscribeToViewChanges",b.update_seq)},this)},this,"Synched"],["getDocument",function(){a.request("CouchDB",
{method:"GET",path:"/"+h+"/"+c},function(b){b=JSON.parse(b);b._id?(this.reset(b),i.event("subscribeToDocumentChanges")):k.reject(this)},this)},this,"Synched"]],Synched:[["updateDatabase",function(){a.request("CouchDB",{method:"PUT",path:"/"+h+"/"+c,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(){i.event("subscribeToDocumentChanges")})},this],["subscribeToViewChanges",function(b){a.listen("CouchDB","/"+h+"/_changes?feed=continuous&heartbeat=20000&since="+b,function(b){if(b==
"\n")return false;var b=JSON.parse(b),a;a=b.deleted?"delete":b.changes[0].rev.search("1-")==0?"add":"change";i.event(a,b.id)},this)},this,"Listening"],["subscribeToDocumentChanges",function(){a.listen("CouchDB","/"+h+"/_changes?feed=continuous&heartbeat=20000",function(b){if(b=="\n")return false;b=JSON.parse(b);b.id==c&&b.changes.pop().rev!=this.get("_rev")&&(b.deleted?i.event("deleteDoc"):i.event("updateDoc"))},this)},this,"Listening"]],Listening:[["entry",function(){k.resolve(this)},this],["change",
function(c){a.request("CouchDB",{method:"GET",path:"/"+h+"/_design/"+f+"/_view/"+b},function(b){JSON.parse(b).rows.some(function(b,a){b.id==c&&this.set(a,b)},this)},this)},this],["delete",function(b){this.loop(function(a,c){a.id==b&&this.del(c)},this)},this],["add",function(c){a.request("CouchDB",{method:"GET",path:"/"+h+"/_design/"+f+"/_view/"+b},function(b){JSON.parse(b).rows.some(function(b,a){b.id==c&&this.alter("splice",a,0,b)},this)},this)},this],["updateDoc",function(){a.request("CouchDB",
{method:"GET",path:"/"+h+"/"+c},function(b){this.reset(JSON.parse(b))},this)},this],["deleteDoc",function(){this.reset({})},this],["updateDatabase",function(){a.request("CouchDB",{method:"PUT",path:"/"+h+"/"+c,headers:{"Content-Type":"application/json"},data:this.toJSON()})},this],["removeFromDatabase",function(){a.request("CouchDB",{method:"DELETE",path:"/"+h+"/"+c+"?rev="+this.get("_rev")})},this]]});this.sync=function(a,e,d){if(typeof a=="string"&&typeof e=="string"&&typeof d=="string")return h=
a,f=e,b=d,i.event("getView"),k;else if(typeof a=="string"&&typeof e=="string"&&typeof d=="undefined")return h=a,c=e,i.event("getDocument"),k;return false};this.update=function(){return i.event("updateDatabase")};this.remove=function(){return i.event("removeFromDatabase")};this.getDBInfo=function(b){return j[b]};this.setTransport=function(b){return b&&typeof b.listen=="function"&&typeof b.request=="function"?(a=b,true):false};this.getStateMachine=function(){return i};this.getTransport=function(){return a}}
return function(){c.prototype=new a;return new c}});
define("Observable",["Tools"],function(a){return function(){var d={};this.watch=function(a,e,c){if(typeof e=="function"){var g=d[a]=d[a]||[];observer=[e,c];g.push(observer);return[a,g.indexOf(observer)]}else return false};this.unwatch=function(a){var e=a[0],a=a[1];return d[e]&&d[e][a]?(delete d[e][a],d[e].some(function(a){return!!a})||delete d[e],true):false};this.notify=function(f){var e=d[f],c;if(e){for(c=e.length;c--;)e[c]&&e[c][0].apply(e[c][1]||null,a.toArray(arguments).slice(1));return true}else return false};
this.hasObserver=function(a){return!(!a||!d[a[0]]||!d[a[0]][a[1]])};this.hasTopic=function(a){return!!d[a]};this.unwatchAll=function(a){d[a]?delete d[a]:d={};return true}}});
define("Promise",["Observable","StateMachine"],function(a,d){return function(){var f,e,c=new d("Unresolved",{Unresolved:[["resolve",function(a){f=a;g.notify("success",a)},"Resolved"],["reject",function(a){e=a;g.notify("fail",a)},"Rejected"],["addSuccess",function(a,b){g.watch("success",a,b)}],["addFail",function(a,b){g.watch("fail",a,b)}]],Resolved:[["addSuccess",function(a,b){a.call(b,f)}]],Rejected:[["addFail",function(a,b){a.call(b,e)}]]}),g=new a;this.resolve=function(a){return c.event("resolve",
a)};this.reject=function(a){return c.event("reject",a)};this.then=function(a,b,e,d){a instanceof Function&&(b instanceof Function?c.event("addSuccess",a):c.event("addSuccess",a,b));b instanceof Function&&c.event("addFail",b,e);e instanceof Function&&c.event("addFail",e,d);return this};this.getObservable=function(){return g};this.getStateMachine=function(){return c}}});
define("StateMachine",["Tools"],function(a){function d(){var d={};this.add=function(a,c,g,h){var b=[];if(d[a])return false;return typeof a=="string"&&typeof c=="function"?(b[0]=c,typeof g=="object"&&(b[1]=g),typeof g=="string"&&(b[2]=g),typeof h=="string"&&(b[2]=h),d[a]=b,true):false};this.has=function(a){return!!d[a]};this.event=function c(c){var g=d[c];return g?(g[0].apply(g[1],a.toArray(arguments).slice(1)),g[2]):false}}return function(f,e){var c={},g="";this.init=function(a){return c[a]?(g=a,
true):false};this.add=function(a){return c[a]?false:c[a]=new d};this.get=function(a){return c[a]};this.getCurrent=function(){return g};this.event=function(e){var b;b=c[g].event.apply(c[g].event,a.toArray(arguments));return b===false?false:(b&&(c[g].event("exit"),g=b,c[g].event("entry")),true)};a.loop(e,function(a,b){var c=this.add(b);a.forEach(function(a){c.add.apply(null,a)})},this);this.init(f)}});
define("Store",["Observable","Tools"],function(a,d){return function(f){var e=d.clone(f)||{},c=new a,g=new a,h=function(a){var f=d.objectsDiffs(a,e);["updated","deleted","added"].forEach(function(a){f[a].forEach(function(b){c.notify(a,b,e[b]);g.notify(b,e[b])})})};this.getNbItems=function(){return e instanceof Array?e.length:d.count(e)};this.get=function(a){return e[a]};this.has=function(a){return e.hasOwnProperty(a)};this.set=function(a,d){var f;return typeof a!="undefined"?(f=this.has(a),e[a]=d,
c.notify(f?"updated":"added",a,e[a]),g.notify(a,e[a]),true):false};this.del=function(a){return this.has(a)?(this.alter("splice",a,1)||(delete e[a],c.notify("deleted",a),g.notify(a)),true):false};this.alter=function(a){var c,g;return e[a]?(g=d.clone(e),c=e[a].apply(e,Array.prototype.slice.call(arguments,1)),h(g),c):false};this.watch=function(a,e,d){return c.watch(a,e,d)};this.unwatch=function(a){return c.unwatch(a)};this.getStoreObservable=function(){return c};this.watchValue=function(a,c,e){return g.watch(a,
c,e)};this.unwatchValue=function(a){return g.unwatch(a)};this.getValueObservable=function(){return g};this.loop=function(a,c){d.loop(e,a,c)};this.reset=function(a){if(a instanceof Object){var c=d.clone(e);e=d.clone(a)||{};h(c);return true}else return false};this.toJSON=function(){return JSON.stringify(e)}}});
define("Tools",function(){return{getGlobal:function(){return function(){return this}.call(null)},mixin:function(a,d,f){this.loop(a,function(e,c){if(!d[c]||!f)d[c]=a[c]});return d},count:function(a){var d=0;this.loop(a,function(){d++});return d},compareObjects:function(a,d){return Object.getOwnPropertyNames(a).sort().join("")==Object.getOwnPropertyNames(d).sort().join("")},toArray:function(a){return Array.prototype.slice.call(a)},loop:function(a,d,f){var e,c;if(a instanceof Object&&typeof d=="function"){if(c=
a.length)for(e=0;e<c;e++)d.call(f,a[e],e,a);else for(e in a)a.hasOwnProperty(e)&&d.call(f,a[e],e,a);return true}else return false},objectsDiffs:function(a,d){if(a instanceof Object&&d instanceof Object){var f=[],e=[],c=[],g=[];this.loop(d,function(c,b){c!==a[b]&&typeof a[b]!="undefined"?e.push(b):c===a[b]?f.push(b):typeof a[b]=="undefined"&&g.push(b)});this.loop(a,function(a,b){typeof d[b]=="undefined"&&c.push(b)});return{updated:e,unchanged:f,added:g,deleted:c}}else return false},jsonify:function(a){return a instanceof
Object?JSON.parse(JSON.stringify(a)):false},clone:function(a){return a instanceof Array?a.slice(0):typeof a=="object"&&a!==null&&!(a instanceof RegExp)?this.mixin(a,{}):a},getNestedProperty:function(a,d){if(a&&a instanceof Object)if(typeof d=="string"&&d!=""){var f=d.split(".");f.unshift(a);return f.reduce(function(a,c){return a[c]})}else return typeof d=="number"?a[d]:a;else return a},setNestedProperty:function(a,d,f){if(a&&a instanceof Object)if(typeof d=="string"&&d!=""){var e=d.split(".");e.unshift(a);
return e.reduce(function(a,d,h){e.length==h+1&&(a[d]=f);return a[d]})}else return typeof d=="number"?(a[d]=f,a[d]):a;else return a}}});
define("Transport",["Observable"],function(a){return function(d){var f=null,e=io,c=new a;this.connect=function(a){f=e.connect(a);return!!f};this.getSocket=function(){return f};this.on=function(a,c){f.on(a,c)};this.once=function(a,c){f.once(a,c)};this.emit=function(a,c,b){f.emit(a,c,b)};this.request=function(a,c,b,d){var e=Date.now()+Math.floor(Math.random()*1E6),j=function(){b&&b.apply(d||null,arguments)};f[c.keptAlive?"on":"once"](e,j);c.__eventId__=e;f.emit(a,c);if(c.keptAlive)return function(){f.removeListener(e,
j)}};this.listen=function(a,d,b,e){var f=a+"/"+d,j,k;c.hasTopic(f)||(k=this.request(a,{path:d,method:"GET",keptAlive:true},function(a){c.notify(f,a)},this));j=c.watch(f,b,e);return{stop:function(){c.unwatch(j);c.hasTopic(f)||k()}}};this.getListenObservable=function(){return c};this.connect(d)}});
